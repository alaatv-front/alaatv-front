<template>
  <div>
    <q-tree ref="tree"
            v-model:ticked="ticked"
            v-model:expanded="expandedNodes"
            class="q-ma-lg"
            :nodes="nodes"
            :no-nodes-label="noNodesLabel"
            node-key="id"
            control-color="secondary"
            label-key="title"
            icon="isax:add-square"
            :tick-strategy="tickStrategy"
            @update:ticked="tickedNode"
            @lazy-load="getChildOfNode"
            @update:expanded="nodeExpanded">
      <template v-slot:default-header="prop">
        <span class="node-title">
          {{ prop.node.title }}
          <q-icon :class="editable ? 'edit-btn': 'none-edit-btn'"
                  name="edit"
                  @click.stop
                  @keypress.stop
                  @click="openEditMenu(prop.node) " />
        </span>
      </template>
    </q-tree>
    <q-btn v-if="editable && nodes && !nodes.length && showCreateBtn"
           label="ساخت درخت"
           icon="add"
           color="green"
           flat
           @click="toggleMenu(true)" />
    <q-dialog v-model="editDialog "
              persistent>
      <q-card class="q-pa-md ">
        <q-btn v-close-popup
               flat
               icon="close "
               color="red "
               @click="toggleMenu(false)" />
        <q-tabs v-model="tab"
                narrow-indicator
                dense>
          <q-tab v-if="nodes && !nodes.length"
                 class="text-blue"
                 name="createTree"
                 icon="add"
                 label="ساخت درخت" />
          <q-tab v-if="nodes && nodes.length"
                 class="text-purple"
                 name="editNode"
                 icon="edit"
                 label="ویرایش " />
          <q-tab v-if="nodes && nodes.length"
                 class="text-orange"
                 name="createNewNode"
                 icon="add"
                 label="اضافه کردن گره جدید " />
        </q-tabs>
        <q-tab-panels v-model="tab "
                      animated>
          <q-tab-panel v-if="editable && nodes && !nodes.length"
                       name="createTree">
            <q-input v-model="newTitle"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="نام" />
            <q-input v-model="newOrder"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="ترتیب " />
            <q-input v-model="newType"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="دسته" />
            <q-btn color="green "
                   :loading="loading "
                   @click="addNode()">
              ایجاد درخت
            </q-btn>
          </q-tab-panel>
          <q-tab-panel v-if="editable && nodes && nodes.length"
                       name="editNode">
            <q-input v-model="editedTitle "
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="نام جدید " />
            <q-input v-model="editedOrder"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="ترتیب جدید " />
            <q-btn color="green "
                   :loading="loading "
                   @click="edit">
              ثبت
            </q-btn>
          </q-tab-panel>
          <q-tab-panel v-if="editable && nodes && nodes.length"
                       name="createNewNode">
            <q-input v-model="newTitle"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="نام" />
            <q-input v-model="newOrder"
                     class="q-ma-md gray-input"
                     filled
                     dense
                     placeholder="ترتیب" />
            <q-btn color="green "
                   :loading="loading "
                   @click="addNode() ">
              اضافه شود
            </q-btn>
          </q-tab-panel>
        </q-tab-panels>
      </q-card>
    </q-dialog>
  </div>
</template>

<script>
import { TreeNode, TreeNodeList } from 'src/models/TreeNode.js'

export default {
  name: 'Tree',
  props: {
    tickStrategy: {
      default: 'none'
    },
    noNodesLabel: {
      type: String,
      default: 'درختی ایجاد نشده است!'
    },
    editable: {
      type: Boolean,
      default: false
    },
    showCreateBtn: {
      type: Boolean,
      default: true
    },
    getNodeById: {
      type: Function,
      default: (id, done, fail, callback) => {
      }
    },
    addNewNode: {
      type: Function,
      default: (ParentId, title, order, callback) => {
      }
    },
    editNode: {
      type: Function,
      default: (id, title, order, callback) => {
      }
    }
  },
  emits: [
    'ticked',
    'expanded',
    'lazy-loaded',
    'new-node-added'
  ],
  data: () => {
    return {
      ticked: [],
      expandedNodes: [],
      completeTickedNode: [],
      nodes: [],
      tab: 'createNewNode',
      loading: false,
      newTitle: '',
      newOrder: 1,
      newType: '',
      editedTitle: '',
      editedOrder: 1,
      selectedNode: {},
      editDialog: false
    }
  },

  computed: {
    tabName () {
      return this.editable && this.nodes && !this.nodes.length ? 'createTree' : 'createNewNode'
    }
  },

  watch: {
    editDialog () {
      this.tab = this.tabName
    }
  },

  mounted () {},

  methods: {
    createRoot (nodeData) {
      const treeNodeData = new TreeNode(nodeData)
      treeNodeData.children = (new TreeNodeList(treeNodeData.children)).list
      this.nodes = [treeNodeData]
    },

    tickedNode (target) {
      this.completeTickedNode = []
      target.forEach(id => {
        const node = this.nodes[0].findNode(id)
        if (!node) {
          return
        }
        node.parentOfSelectedNode = this.nodes[0].parentOfSelectedNode
        this.nodes[0].parentOfSelectedNode = []
        this.completeTickedNode.push(node)
      })
      this.$emit('ticked', this.completeTickedNode)
    },

    loadChildOfNode (node, done) {
      const tree = []
      node.children.forEach(child => {
        tree.push(new TreeNode(child))
      })
      done(tree)
      this.$emit('lazy-loaded', tree)
    },

    getChildOfNode ({ node, key, done, fail }) {
      if (node.children && node.children.length) {
        this.showChildOfNodeFromCache(node, key, done, fail)
      } else {
        this.showChildOfNodeFromServer(node, key, done, fail)
      }
    },

    showChildOfNodeFromCache (node, key, done, fail) {
      const tree = []
      node.children.forEach(child => {
        tree.push(new TreeNode(child))
      })
      done(tree)
      this.$emit('lazy-loaded', tree)
    },

    showChildOfNodeFromServer (node, key, done, fail) {
      this.getNodeById(node.id, done, fail, this.loadChildOfNode)
    },

    edit () {
      this.loading = true
      this.editNode(this.selectedNode.id, this.editedTitle, this.editedOrder)
        .then(() => {
          const id = this.selectedNode.id
          const node = this.$refs.tree.getNodeByKey(id)
          node.title = this.editedTitle
          node.order = this.editedOrder
          this.editDialog = false
          this.loading = false
        }).catch(() => {
          this.editDialog = false
          this.loading = false
        })
    },

    addNode () {
      this.loading = true
      const id = this.selectedNode.id ? this.selectedNode.id : ''
      const getNode = this.$refs.tree.getNodeByKey(id)
      this.addNewNode(id, this.newType, this.newTitle, this.newOrder)
        .then(response => {
          getNode.children.unshift(response)
          this.editDialog = false
          this.loading = false
          this.$emit('new-node-added', response)
        }).catch(() => {
          this.editDialog = false
          this.loading = false
        })
    },

    openEditMenu (node) {
      this.selectedNode = {
        id: node.id,
        title: node.title,
        order: node.order
      }
      this.editedTitle = this.selectedNode.title
      this.editedOrder = this.selectedNode.order
      this.editDialog = true
    },

    setNodesTicked (keys, state) {
      if (!state) {
        state = false
      }
      this.$refs.tree.setTicked(keys, state)
    },

    toggleMenu (state) {
      this.editDialog = state
    },

    nodeExpanded (nodeIds) {
      this.$emit('expanded', nodeIds)
    }
  }
}
</script>

<style scoped lang='scss'>
.q-tree {
  display: inline-block;

  .node-title {
    color: var(--3a-TextPrimary);

    &:hover {
      .edit-btn {
        color: #f18305;
      }
    }

    .edit-btn {
      color: transparent;
    }

    .none-edit-btn {
      display: none;
    }
  }
}
</style>
<style lang='scss'>
.q-tree {
  .q-tree__node--parent {
    .q-tree__node-header {
      .q-icon {
        font-size: 20px;
        margin-right: 8px;

        &.q-tree__arrow, &.q-tree__arrow--rotate {
          transform: none !important;
          transition: none !important;
        }

        &.q-tree__arrow--rotate {
          &::before {
            content: "\eb21";
          }
        }
      }
    }
  }
}

.q-tree__node::after {
  inset: 0 auto -31px -13px;
  border-left: 2px solid #d5d6da;
}

.q-tree__node-header::before {
  border-bottom: 0 !important;
  left: -35px;
  bottom: 2px;
  border-left: 2px solid #d5d6da;
}

</style>
